---
# ============================================================
# Routine : Restauration – fichiers du site WordPress
# Tag     : restore_files
# Requiert: restore_files_archive  (chemin absolu .tar.gz)
#           restore_db_file        (chemin absolu .sql)
# Handler : "restore database before files"
#           → la DB est restaurée AVANT les fichiers
# ============================================================

- name: "Restore Files | Vérifier les variables requises"
  ansible.builtin.assert:
    that:
      - restore_files_archive | length > 0
      - restore_files_archive is file
      - restore_db_file | length > 0
      - restore_db_file is file
    fail_msg: >
      Les deux variables 'restore_files_archive' et 'restore_db_file'
      doivent pointer vers des fichiers existants.
  tags: restore_files

- name: "Restore Files | Déclencher la restauration DB d'abord (handler)"
  ansible.builtin.debug:
    msg: "Notification handler : restore database before files"
  notify: "restore database before files"
  changed_when: true
  tags: restore_files

- name: "Restore Files | Forcer l'exécution du handler DB maintenant"
  ansible.builtin.meta: flush_handlers
  tags: restore_files

# ── Restauration des fichiers WordPress ──────────────────────

- name: "Restore Files | Copier l'archive dans le container WordPress"
  ansible.builtin.command:
    cmd: "docker cp {{ restore_files_archive }} {{ wordpress_container }}:/tmp/restore_files.tar.gz"
  changed_when: true
  tags: restore_files

- name: "Restore Files | Arrêter le container WordPress"
  community.docker.docker_container:
    name: "{{ wordpress_container }}"
    state: stopped
  tags: restore_files

- name: "Restore Files | Extraire l'archive"
  ansible.builtin.command:
    cmd: >
      docker run --rm
      --volumes-from {{ wordpress_container }}
      alpine
      tar -xzf /tmp/restore_files.tar.gz -C /
  changed_when: true
  tags: restore_files

- name: "Restore Files | Redémarrer le container WordPress"
  community.docker.docker_container:
    name: "{{ wordpress_container }}"
    state: started
  tags: restore_files

- name: "Restore Files | Supprimer l'archive temporaire"
  community.docker.docker_container_exec:
    container: "{{ wordpress_container }}"
    command: "rm -f /tmp/restore_files.tar.gz"
  tags: restore_files

- name: "Restore Files | Health check WordPress"
  ansible.builtin.uri:
    url: "http://localhost"
    status_code: [200, 301, 302]
    timeout: 30
  register: _wp_health
  retries: 5
  delay: 5
  until: _wp_health.status in [200, 301, 302]
  tags: restore_files

- name: "Restore Files | Afficher le résultat"
  ansible.builtin.debug:
    msg: "Restauration complète. WordPress répond avec HTTP {{ _wp_health.status }}"
  tags: restore_files
