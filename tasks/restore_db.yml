---
# ============================================================
# Routine : Restauration – base de données
# Tag     : restore_db
# Requiert: restore_db_file  (chemin absolu vers le .sql)
# ============================================================

- name: "Restore DB | Vérifier que restore_db_file est défini"
  ansible.builtin.assert:
    that:
      - restore_db_file | length > 0
      - restore_db_file is file
    fail_msg: >
      La variable 'restore_db_file' doit pointer vers un fichier .sql existant.
      Utilisez : -e "restore_db_file=/opt/backups/wordpress/database/db_2024-01-01_120000.sql"
  tags: restore_db

- name: "Restore DB | Copier le dump dans le container MySQL"
  ansible.builtin.command:
    cmd: "docker cp {{ restore_db_file }} {{ mysql_container }}:/tmp/restore.sql"
  changed_when: true
  tags: restore_db

- name: "Restore DB | Supprimer et recréer la base de données"
  community.docker.docker_container_exec:
    container: "{{ mysql_container }}"
    command: >
      mysql -u root -p{{ db_root_password }}
      -e "DROP DATABASE IF EXISTS {{ db_name }};
          CREATE DATABASE {{ db_name }}
          CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
  tags: restore_db

- name: "Restore DB | Importer le dump"
  community.docker.docker_container_exec:
    container: "{{ mysql_container }}"
    command: >
      bash -c "mysql -u root -p{{ db_root_password }} {{ db_name }} < /tmp/restore.sql"
  tags: restore_db

- name: "Restore DB | Supprimer le fichier temporaire dans le container"
  community.docker.docker_container_exec:
    container: "{{ mysql_container }}"
    command: "rm -f /tmp/restore.sql"
  tags: restore_db

- name: "Restore DB | Vérifier le nombre de tables importées"
  community.docker.docker_container_exec:
    container: "{{ mysql_container }}"
    command: >
      mysql -u root -p{{ db_root_password }} {{ db_name }}
      -e "SELECT COUNT(*) AS table_count
          FROM information_schema.TABLES
          WHERE TABLE_SCHEMA='{{ db_name }}';"
  register: _restore_check
  tags: restore_db

- name: "Restore DB | Afficher le résultat"
  ansible.builtin.debug:
    msg: "{{ _restore_check.stdout_lines }}"
  tags: restore_db
